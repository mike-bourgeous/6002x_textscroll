<!DOCTYPE html>
<html>
	<head>
		<title>Foundations of Analog and Digital Electronic Circuits - Agarwal, Lang</title>
		<link rel="stylesheet" type="text/css" media="all" href="https://6002x.mitx.mit.edu/static/css/application.css?v4">
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
	</head>
	<body>
		<div class="header-wrapper">
			<header>
			<hgroup>
			<h1><em>MITx</em></h1>
			<h2><a href="/courseware">Circuits and Electronics</a></h2>
			</hgroup>
			<nav class="book">
			<ul class="coursenav">
				<li class="courseware"><a href="/courseware">Courseware</a></li>
				<li class="info"><a href="/info">Course Info</a></li>
				<li class="book"><a href="/book">Textbook</a></li>
				<li class="discussion"><a href="/discussion/questions">Discussion</a></li>
				<li class="wiki"><a href="/wiki/view">Wiki</a></li>
				<li class="profile"><a href="/profile">Profile</a></li>
			</ul>
			</nav>
			</header>
		</div>
		<section class="main-content">
			<section class="book">
				<section class="page">
				Textbook content goes here.
				</section>
			</section>
		</secton>

		<script type="text/javascript">
			// Infinite scrolling MITx 6002x textbook
			// A quick hack by Mike Bourgeous (nitrogenaudio.com/contact.html)

			var IS_TXT = IS_TXT || {
				firstPage: 0, // First physical page number (i.e. number of first image)
				lastPage: 1008, // Number of last image
				pageOne: 25, // Physical page number of page 1
				pageDigits: 3, // Minimum number of digits in image filenames
				pageWidth: 960, // Width of a page in pixels
				pageHeight: 1080, // Height of a page in pixels
				urlPrefix: '[image_uri]',
				urlSuffix: '.png',

				pagesBefore: 1, // Number of pages to load before the current page (should be >= 1)
				totalPages: 4, // Total number of pages to keep loaded
			};

			function infiniteScrollingTextbook() {
				// Pads nbr to at least the given number of digits using leading zeros.
				IS_TXT.zeroPad = function(nbr, digits) {
					var zeros = digits - nbr.toString().length;
					var str = '';

					for(var i = 0; i < zeros; i++) {
						str += '0';
					}
					str += nbr.toString();

					return str;
				}

				// Excludes values in range1 from range2, operating under the assumption that
				// neither range will entirely enclose the other, with leftover elements on
				// both ends.  Range1 and range2 should both be two-numeric-element arrays.
				// The original arrays are not modified.
			// Example: IS_TXT.excludeRange([15, 20], [19, 24]) returns [21, 24].
				IS_TXT.excludeRange = function(range1, range2) {
					var min1 = range1[0];
					var max1 = range1[1];
					var min2 = range2[0];
					var max2 = range2[1];

					if(max1 < min2 || min1 > max2) {
						// range1 and range2 do not overlap
						return range2;
					}

					if(min1 <= min2 && max1 >= max2) {
						// range1 entirely eliminates range2
						min2 = -1;
						max2 = -1;
					} else if(max1 >= min2 && min1 <= min2) {
						// range1 chops elements off the beginning of range2
						min2 = max1 + 1;
					} else if(min1 <= max2 && max1 >= max2) {
						// range1 chops elements off the end of range2
						max2 = min1 - 1;
					} else {
						// range1 lies within range2, creating an invalid split
						throw 'Range2 encloses range1: [' + range1.join(', ') + '] and ['
							+ range2.join(', ') + '] -- unable to split range';
					}

					return [min2, max2];
				}

				// Creates an unloaded img tag for the given page number.
				IS_TXT.makeImage = function(pageno) {
					var pageStr = IS_TXT.zeroPad(pageno, IS_TXT.pageDigits);
					var image = document.createElement('img');
					$(image).attr('id', 'page_' + pageno)
						.attr('alt', 'Page ' + (pageno - IS_TXT.pageOne + 1))
						.attr('data-src', '' + IS_TXT.urlPrefix + pageStr + IS_TXT.urlSuffix)
						.css('width', '' + (IS_TXT.pageWidth) + 'px')
						.css('height', '' + (IS_TXT.pageHeight) + 'px')
						.css('margin', '0')
						.css('padding', '0');
					return image;
				}

				// Creates a section with unloaded img tag for the given page number.
				IS_TXT.makePage = function(pageno) {
					var section = document.createElement('section');
					$(section).attr('class', 'page')
						.css('width', '' + (IS_TXT.pageWidth) + 'px')
						.css('height', '' + (IS_TXT.pageHeight) + 'px')
						.css('border', 'solid 1px black')
						.css('margin', '10px auto')
						.css('padding', '10px')
						.html(IS_TXT.makeImage(pageno));
					return section;
				}

				// Returns the currently visible page number based on scroll bar position.
				// Includes fractional page amount.
				IS_TXT.currentPage = function() {
					var offset = $(document).scrollTop() + $(window).height() / 2 - IS_TXT.scrollStart;
					var pageno = offset / IS_TXT.scrollOffset + IS_TXT.firstPage;

					return Math.min(Math.max(pageno, IS_TXT.firstPage), IS_TXT.lastPage);
				}

				// Returns the integer logical page number of the currently visible page.
				IS_TXT.currentLogicalPage = function() {
					return Math.floor(IS_TXT.currentPage() - IS_TXT.pageOne + 1);
				}

				// Returns the minimum and maximum pages to load, inclusive.
				// If pageno is unspecified, the current page will be used.
				IS_TXT.pageRange = function(pageno) {
					pageno = pageno || IS_TXT.currentPage();
					var minPage = Math.floor(pageno) - IS_TXT.pagesBefore;
					var maxPage = minPage + IS_TXT.totalPages - 1;

					minPage = Math.min(Math.max(minPage, IS_TXT.firstPage), IS_TXT.lastPage);
					maxPage = Math.min(Math.max(maxPage, IS_TXT.firstPage), IS_TXT.lastPage);

					return [minPage, maxPage];
				}

				// Loads the pages within the specified range, inclusive.  The range
				// may be specified as a two-element integer array passed in min.
				IS_TXT.loadPages = function(min, max) {
					if(min instanceof Array) {
						max = min[1];
						min = min[0];
					}

					for(var i = min; i <= max; i++) {
						var img = $(IS_TXT.pages[i - IS_TXT.firstPage]).find('img');
						img.attr('src', img.attr('data-src'))
							.css('border', 'solid 1px #ccc');
					}
				}

				// Unloads the pages within the specified range, inclusive.  The range
				// may be specified as a two-element integer array passed in min.
				IS_TXT.unloadPages = function(min, max) {
					if(min instanceof Array) {
						max = min[1];
						min = min[0]
					}

					for(var i = min; i <= max; i++) {
						var page = $(IS_TXT.pages[i - IS_TXT.firstPage]);
						page.html(IS_TXT.makeImage(i))
					}
				}

				// Scrolls to the top of the given page
				IS_TXT.scrollToPage = function(pageno) {
					$(document).scrollTop($(IS_TXT.pages[pageno - IS_TXT.firstPage]).offset().top - 10);
				}

				// Loads and unloads pages based on the current scroll position.
				IS_TXT.updateScroll = function() {
					// TODO

					var pageno = IS_TXT.currentPage();
					console.log("XXX: Current page is " + pageno);

					if(Math.floor(pageno) != Math.floor(IS_TXT.lastPageno)) {
						console.log("Integer page number " + Math.floor(pageno) + " differs from previous: " + Math.floor(IS_TXT.lastPageno));

						var oldRange = IS_TXT.lastPagerange || [-1, -1];
						var newRange = IS_TXT.pageRange(pageno);
						var unloadRange = IS_TXT.excludeRange(newRange, oldRange);
						var loadRange = IS_TXT.excludeRange(oldRange, newRange);

						console.log("Previous range: " + oldRange);
						console.log("New range: " + newRange);
						console.log("Pages to unload: " + unloadRange);
						console.log("Pages to load: " + loadRange);

						IS_TXT.unloadPages(unloadRange);
						IS_TXT.loadPages(loadRange);

						IS_TXT.lastPageno = pageno;
						IS_TXT.lastPagerange = newRange;
					}
				}

				// Initializes the Infinite Scrolling Textbook.  Creates DOM elements
				// for every page, sets scroll handlers to load visible pages.
				IS_TXT.init = function() {
					var container = $('section.page, section.page-container')
						.first().attr('class', 'page-container')
						.text('');

					IS_TXT.pages = [];
					for(var i = IS_TXT.firstPage; i <= IS_TXT.lastPage; i++) {
						IS_TXT.pages[i - IS_TXT.firstPage] = IS_TXT.makePage(i);
						container.append(IS_TXT.pages[i]);
					}

					IS_TXT.scrollStart = $(IS_TXT.pages[0]).offset().top;
					IS_TXT.scrollOffset = $(IS_TXT.pages[1]).offset().top - IS_TXT.scrollStart;

					$(document).scroll(IS_TXT.updateScroll);
					IS_TXT.updateScroll();
				}

				IS_TXT.init();

				var old_goto_page = window.goto_page;
				window.goto_page = function(pageno) {
					if(old_goto_page) {
						old_goto_page(pageno);
					}

					IS_TXT.scrollToPage(pageno);
				}
			}
			$(infiniteScrollingTextbook);
		</script>
	</body>
</html>
